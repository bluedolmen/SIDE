<?xml version="1.0"?>
<project name="TestANT" default="pre-build">
	
	<property file="build.properties"/>	
	<property file="data_post.properties"/>

	<!-- =========================================================================
							      pre-build task
	     ========================================================================= -->
	
	<target name="isAlfrescoRunningBefore">
		<waitfor maxwait="4" maxwaitunit="second" checkevery="250" timeoutproperty="alfrescoOff">
			<http errorsbeginat="200" url="http://localhost:${alfresco.port}/alfresco"/>
		</waitfor>
	</target>
	
	<target name="stopAlfresco">
		<java jar="${alfresco.dir}/tomcat/bin/bootstrap.jar" fork="true">
			<jvmarg value="-Dcatalina.home=${alfresco.dir}/tomcat"/>
			<arg line="stop"/>
		</java>
	</target>
	
	<target name="pre-build" depends="isAlfrescoRunningBefore" unless="alfrescoOff">
		<antcall target="stopAlfresco"/>
	</target>
	
	<!--<target name="pre-build">
		<echo message="Version=${ant.version}"/>
	</target>-->
	
	<!-- =========================================================================
								      post-build task
		 ========================================================================= -->
	
	<target name="post-build">
		<parallel>
			<antcall target="startAlfresco"/>
			<antcall target="createAlfSynchro"/>
			<antcall target="loadData"/>
		</parallel>
	</target>
	
	<target name="startAlfresco">
		<exec executable="${alfresco.dir}\alf_start.sh" />
	</target>
	
	<target name="isMySqlRunning">
		<waitfor maxwait="1" maxwaitunit="minute" checkevery="250">
			<socket server="dbserver" port="${mysql.port}"/>
		</waitfor>
	</target>
	
	<target name="createAlfSynchro" depends="isMySqlRunning">
		<sql classpath="${alfresco.dir}\tomcat\lib\mysql-connector-java-5.1.7-bin.jar"
			 driver="org.gjt.mm.mysql.Driver"
			 url="jdbc:mysql://localhost/alfresco"
			 userid="${user.db}"
			 password="${passwd.db}">
			create database if not exists alf_synchro default character set utf8;
			grant all on alf_synchro.* to 'alfresco'@'localhost' identified by 'alfresco' with grant option;
		</sql>
		<echo message="Database alf_synchro created."/>
	</target>
	
	<target name="isAlfrescoRunning">
		<waitfor maxwait="4" maxwaitunit="minute" checkevery="500">
			<http url="http://localhost:${alfresco.port}/alfresco"/>
		</waitfor>
	</target>
	
	<target name="loadData" depends="isAlfrescoRunning">
		<taskdef name="post" classname="ise.antelope.tasks.PostTask" classpath="dist/antelopetasks-3.2.10.jar"/>
		<post file="data_post.properties" to="http://localhost:${alfresco.port}/alfresco/service/data/generate/generate"
		      verbose="true">
		</post>
	</target>
	
	<!-- =========================================================================
		 ========================================================================= -->
</project>
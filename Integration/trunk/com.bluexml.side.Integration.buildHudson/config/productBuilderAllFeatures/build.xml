<project default="main" name="Community RCP Builder">
	<property file="build.${user.name}.properties" />
	<property file="build.properties" />
	<property name="buildDirectory" value="${builder}/buildDirectory" />
	<property name="pluginPath" value="${moreplugins}${path.separator}${sideSources}${path.separator}${deltapack}" />
	<taskdef name="xmltask" classname="com.oopsconsultancy.xmltask.ant.XmlTask" classpath="../lib/xmltask.jar" />

	<target name="main">
		<!-- clean prevous build -->
		<delete dir="${distros}" />
		<mkdir dir="${distros}" />
		<!-- by default, check for deltapack co-located with eclipse -->

		<!-- Check that we have a deltapack -->
		<available property="haveDeltaPack" file="${deltapack}" />
		<fail unless="haveDeltaPack" message="The deltapack is required to build this product.  Please edit buildProduct.xml or set the &quot;deltapack&quot; property." />
		<echoproperties />
		<echo message="builder : ${eclipse.pdebuild.scripts}/productBuild/productBuild.xml" />
		<ant antfile="${eclipse.pdebuild.scripts}/productBuild/productBuild.xml" />
		<!--<antcall target="fixArchives" />-->
	</target>


	<!-- - - - - - - - - - - - - - - - - - 
          target: fixArchives                      
         - - - - - - - - - - - - - - - - - -->
	<target name="fixArchives">
		<mkdir dir="${distros}" />
		<move todir="${distros}" overwrite="true" verbose="true">
			<fileset dir="${buildDirectory}/${buildLabel}">
				<include name="*.zip" />
				<include name="*.tar.gz" />
			</fileset>
		</move>
	</target>


	<target name="fixExecutalbeBit_MacOS">
		<echo message="Fix executable bit" />
		<delete dir="${builder}_tmp" includeemptydirs="true" failonerror="false">
		</delete>
		<unzip dest="${builder}_tmp" src="${distros}/${buildId}-macosx.carbon.x86.zip">
		</unzip>
		<!-- startup argument is missing and this disable RCP to update so we override the side.ini-->
		<copy file="side.ini" tofile="${builder}_tmp/${archivePrefix}/${launcherName}.app/Contents/MacOS/${launcherName}.ini" verbose="true" overwrite="trues" />
		<zip destfile="${distros}/${buildId}-macosx.carbon.x86.zip" update="false">
			<zipfileset prefix="${archivePrefix}" dir="${builder}_tmp/${archivePrefix}" id="id" filemode="777">
				<include name="${launcherName}.app/Contents/MacOS/${launcherName}" />
			</zipfileset>
			<zipfileset prefix="${archivePrefix}" dir="${builder}_tmp/${archivePrefix}" id="id2">
				<exclude name="${launcherName}.app/Contents/MacOS/${launcherName}" />
			</zipfileset>
		</zip>
	</target>
	<target name="fixExecutalbeBit_Linux">
		<echo message="Fix executable bit" />
		<delete dir="${builder}_tmp" includeemptydirs="true" failonerror="false">
		</delete>
		<unzip dest="${builder}_tmp" src="${distros}/${buildId}-linux.gtk.x86.zip">
		</unzip>
		<zip destfile="${distros}/${buildId}-linux.gtk.x86.zip" update="false">
			<zipfileset prefix="${archivePrefix}" dir="${builder}_tmp/${archivePrefix}" id="id" filemode="777">
				<include name="${launcherName}" />
			</zipfileset>
			<zipfileset prefix="${archivePrefix}" dir="${builder}_tmp/${archivePrefix}" id="id2">
				<exclude name="${launcherName}" />
			</zipfileset>
		</zip>
	</target>

	
	<target name="pde-build2" description="call this target to execute main task using Eclipse antRunner">
		<echo message="launcher path :${baseLocation}/plugins/org.eclipse.equinox.launcher_${equinoxLauncherPluginVersion}.jar">
		</echo>
		<delete file="${logFile}" failonerror="false" />
		<record name="${logFile}" loglevel="debug" action="start" />
		<java fork="true" failonerror="true" jar="${baseLocation}/plugins/org.eclipse.equinox.launcher_${equinoxLauncherPluginVersion}.jar">
			<jvmarg line="${build.jvm.options}" />
			<arg value="-application" />
			<arg value="org.eclipse.ant.core.antRunner" />
			<arg value="-buildfile" />
			<arg value="build.xml" />
			<arg value="-Dtimestamp=${timestamp}" />
			<arg value="-Dworkspace=${workspace}" />
			<classpath>
				<pathelement location="${baseLocation}/plugins/org.eclipse.equinox.launcher_${equinoxLauncherPluginVersion}.jar" />
			</classpath>
		</java>
		<record name="${logFile}" action="stop" />
	</target>


	<!-- = = = = = = = = = = = = = = = = =
          macrodef: executeEclipsAnt          
         = = = = = = = = = = = = = = = = = -->
	<macrodef name="executeEclipsAnt">
		<attribute name="baseLocation" default="${baseLocation}" />
		<attribute name="equinoxLauncherPluginVersion" default="${equinoxLauncherPluginVersion}" />
		<attribute name="logFile" default="${logFile}" />
		<attribute name="buildFile" default="build.xml" />
		<attribute name="build.jvm.options" default="${build.jvm.options}"/>
		<sequential>
			<echo message="launcher path :@{baseLocation}/plugins/org.eclipse.equinox.launcher_@{equinoxLauncherPluginVersion}.jar">
			</echo>
			<delete file="@{logFile}" failonerror="false" />
			<record name="@{logFile}" loglevel="debug" action="start" />
			<java fork="true" failonerror="true" jar="@{baseLocation}/plugins/org.eclipse.equinox.launcher_@{equinoxLauncherPluginVersion}.jar">
				<jvmarg line="@{build.jvm.options}" />
				<arg value="-application" />
				<arg value="org.eclipse.ant.core.antRunner" />
				<arg value="-buildfile" />
				<arg value="@{buildFile}" />
				<arg line="@{extraParameters}" />
				<classpath>
					<pathelement location="@{baseLocation}/plugins/org.eclipse.equinox.launcher_@{equinoxLauncherPluginVersion}.jar" />
				</classpath>
			</java>
			<record name="@{logFile}" action="stop" />
		</sequential>
	</macrodef>

</project>

<?xml version="1.0"?>

<project name="com.bluexml.side.Integration.alfresco.associationSynchronisation" default="package-amp" basedir=".">

	<property file="config/module.properties"/>
	
	<property name="alfresco.sdk" value="/home/pajot-b/src/Alfresco_SDK/lib/server" />
	<property name="tomcat.dir" value="/home/pajot-b/opt/alfresco3/tomcat" />
	
	<property name="project.id" value="${module.id}"/>
    <property name="project.dir" value="."/>
	<property name="source.dir.name" value="source"/>	
	<property name="build.dir.name" value="build"/>
    <property name="config.dir.name" value="config"/>
	<property name="lib.dir.name" value="lib" />
	<property name="web.dir.name" value="web" />
	<property name="licences.dir.name" value="licences" />
		
    <property name="source.dir" value="${project.dir}/${source.dir.name}"/>
    <property name="build.dir" value="${project.dir}/${build.dir.name}"/>
    <property name="config.dir" value="${project.dir}/${config.dir.name}"/>
	<property name="lib.dir" value="${project.dir}/${lib.dir.name}" />
	<property name="web.dir" value="${project.dir}/${web.dir.name}" />
	<property name="licences.dir" value="${project.dir}/${licences.dir.name}" />
	
    <property name="jar.file" value="${build.dir}/lib/${project.id}.jar"/>
    <property name="amp.file" value="${build.dir}/dist/${project.id}.amp"/>
	
	
    <target name="mkdirs">
        <mkdir dir="${build.dir}/dist" />
        <mkdir dir="${build.dir}/lib" />
    </target>
    
    <path id="class.path">
        <dirset dir="${build.dir}" />
    	<fileset dir="${lib.dir}" includes="**/*.jar" />
        <fileset dir="${alfresco.sdk}" includes="**/*.jar" />
    </path>

	<target name="clean">
		<delete dir="${build.dir}/classes" />
	</target>

    <target name="compile" depends="clean">
        <mkdir dir="${build.dir}/classes" />
        <javac classpathref="class.path" srcdir="${source.dir}" destdir="${build.dir}/classes" debug="on" />
    </target>
	    
    <target name="package-jar" depends="compile">
        <jar destfile="${jar.file}" >
            <fileset dir="${build.dir}/classes" excludes="test*/**/*,**/custom*,**/*Test*" includes="**/*.class" />
        </jar>
    </target>
	
    <target name="package-amp" depends="mkdirs, package-jar" description="Package the Module" >
        <zip destfile="${amp.file}" >
        	<fileset dir="${project.dir}" includes="lib/*.jar" excludes="*/do-not-package/**/*.*"/>
            <fileset dir="${build.dir}" includes="lib/*.jar" />
            <fileset dir="${project.dir}" includes="${web.dir.name}/**/*.*" />
            <fileset dir="${project.dir}" includes="${licences.dir.name}/**/*.*" />
            <fileset dir="${project.dir}" includes="${config.dir.name}/**/*.*" excludes="**/module.properties" />
        	<fileset dir="${config.dir}" includes="module.properties" />
        </zip>
    </target>

	<target name="update-tomcat-jar" depends="package-jar">
		<copy file="${jar.file}" todir="${tomcat.dir}/webapps/alfresco/WEB-INF/lib/" />
	</target>
	
    <target name="update-war" depends="package-amp" description="Update the WAR file.  Set -Dwar.file=..." >
        <echo>Installing ${project.id} into WAR</echo>
        <java dir="." fork="true" classname="org.alfresco.repo.module.tool.ModuleManagementTool">
            <classpath refid="class.path" />
            <arg line="install ${amp.file} ${war.file} -force -verbose"/>
        </java>
    </target>

</project>
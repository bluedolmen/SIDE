<?xml version='1.0' encoding='ISO-8859-1'?>
<beans xmlns="http://www.springframework.org/schema/beans"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xmlns:aop="http://www.springframework.org/schema/aop"
		xmlns:tx="http://www.springframework.org/schema/tx"
		xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
				http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd
				http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.0.xsd">

	<!-- ======================= -->
    <!-- .utils beans            -->
    <!-- ======================= -->

	<!-- 
	<bean id="sqlDataSourceManager" class="com.bluexml.alfresco.modules.sql.utils.DataSourceManager" singleton="true" init-method="init">
	</bean>
	 -->

	<bean id="sqlDatabaseQuery" class="com.bluexml.alfresco.modules.sql.utils.DatabaseQuery">
		<!-- 
		<property name="dataSourceManager">
			<ref bean="sqlDataSourceManager" />
		</property>
		 -->
	</bean>

	<!-- ======================= -->
    <!-- .searcher beans         -->
    <!-- ======================= -->


	<bean id="SQLSearchService" class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="proxyInterfaces">
            <value>com.bluexml.alfresco.modules.sql.searcher.SQLSearchService</value>
        </property>
        <property name="target">
            <ref local="sqlSearch"/>
        </property>
        <property name="interceptorNames">
            <list>
                <idref local="sqlSearchIntegrationService_transaction"/>
                <idref bean="AuditMethodInterceptor"/>
                <idref bean="exceptionTranslator"/>            
                <idref local="sqlSearchService_security"/>
            </list>
        </property>
    </bean>

	<bean id="sqlSearch" class="com.bluexml.alfresco.modules.sql.searcher.SQLSearch">
		<property name="databaseQuery">
			<ref local="sqlDatabaseQuery" />
		</property>
	</bean>

    <bean id="sqlSearchIntegrationService_transaction" class="org.springframework.transaction.interceptor.TransactionInterceptor">
        <property name="transactionManager">
            <ref bean="transactionManager"/>
        </property>
        <property name="transactionAttributes">
            <props>
                <prop key="*">${server.transaction.mode.default}</prop>
            </props>
        </property>
    </bean>


	<!-- ======================= -->
    <!-- .synchronisation beans  -->
    <!-- ======================= -->

	<bean id="datatabaseDictionary" class="com.bluexml.alfresco.modules.sql.synchronisation.DatabaseDictionary" factory-method="getDatabaseDictionary">
	</bean>

 	<bean id="sqlPolicy" class="com.bluexml.alfresco.modules.sql.synchronisation.SQLSynchronisationPolicy" init-method="init">
 		<property name="serviceRegistry" ref="ServiceRegistry"/>
 		<property name="nodeService" ref="nodeService" />
		<property name="policyComponent" ref="policyComponent" />
		<property name="dictionaryService" ref="dictionaryService" />
		<property name="basicService" ref="basicService" />
		<property name="jpaAssociationDictionary" ref="jpaAssociationDictionary" />
		<!-- 
		<property name="dataSourceManager" ref="sqlDataSourceManager" />
		 -->
	</bean>

	<bean id="jpaAssociationDictionary" class="com.bluexml.alfresco.modules.sql.utils.JPAAssociationDictionary">
		<property name="resourcePattern" value="classpath*:alfresco/module/*/association_translation.properties" />
	</bean>

	<!-- ======================= -->
    <!-- Webscript definition    -->
    <!-- ======================= -->
	 
	 <bean id="webscript.extension.com.bluexml.modules.sql-extension.request.get" class="com.bluexml.alfresco.modules.sql.webscript.SQLSearchServiceWebscript" 
	    init-method="init" parent="webscript">
	    <property name="serviceRegistry" ref="ServiceRegistry" />
	    <property name="SQLSearchService" ref="SQLSearchService"></property>
	</bean>
	
	<!-- ======================= -->
    <!-- Search Service Security -->
    <!-- ======================= -->

    <!-- All search results are filtered to exclude nodes that the current user can not        -->
    <!-- read. Other methods restrict queries to those nodes the user can read                 -->

    <bean id="sqlSearchService_security" class="net.sf.acegisecurity.intercept.method.aopalliance.MethodSecurityInterceptor">
        <property name="authenticationManager"><ref bean="authenticationManager"/></property>
    	<property name="accessDecisionManager"><ref bean="accessDecisionManager"/></property>
        <property name="afterInvocationManager"><ref bean="afterInvocationManager"/></property>
        <property name="objectDefinitionSource">
            <value>
            	<!--
            	com.bluexml.alfresco.modules.sql.searcher.SearchService.query=ACL_METHOD.ROLE_AUTHENTICATED
              	-->
                com.bluexml.alfresco.modules.sql.searcher.SQLSearchService.query=AFTER_ACL_NODE.sys:base.Read
            
            </value>
        </property>
    </bean>

	<!-- ============================= -->
    <!-- Hibernate/JPA synchronisation -->
    <!-- ============================= -->

    <bean id="persistenceUnitManager" class="org.springframework.orm.jpa.persistenceunit.DefaultPersistenceUnitManager">
        <property name="persistenceXmlLocations">
            <list>
                <value>classpath*:alfresco/module/*/persistence.xml</value>
            </list>
        </property>
        <property name="defaultDataSource" ref="synchroDataSource"/>
    </bean>

	<bean id="synchroDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
	    <property name="driverClassName" value="org.gjt.mm.mysql.Driver"/>
	    <property name="url" value="jdbc:mysql://localhost/alf_jpa"/>
	    <property name="username" value="alfresco"/>
	    <property name="password" value="alfresco"/>
	</bean>

	<!-- JPA EntityManagerFactory -->
	<bean id="synchroEntityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
	    <property name="persistenceUnitManager" ref="persistenceUnitManager"/>
		<!-- <property name="dataSource" ref="synchroDataSource"/> -->
		<property name="jpaVendorAdapter">
			<bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter">
				<property name="showSql" value="true" />
				<property name="generateDdl" value="true" />
				<property name="databasePlatform" value="org.hibernate.dialect.MySQL5Dialect" />
			</bean>
		</property>
	</bean>
	
	<bean id="synchroTransactionManager" class="org.springframework.orm.jpa.JpaTransactionManager" >
		<property name="entityManagerFactory" ref="synchroEntityManagerFactory" />
	</bean>
	<!-- 
	 -->
	
	<!--
		Instruct Spring to perform declarative transaction management automatically
		on annotated classes.
		Brice: cannot be used with alfresco since previous configuration yields to a
		problem in loading the context with this option
	<tx:annotation-driven />	
	-->
	<!-- 
	<context:annotation-config/>
	-->
	 
	<!--
		PostProcessors to perform resource injection according to the JPA specification
	  (@PersistenceContext, @PersistenceUnit).
	-->
	<bean class="org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor" />
	 
	 <!--
		PostProcessors to perform exception translation on @Repository classes (from native
		exceptions such as JPA PersistenceExceptions to Spring's DataAccessException hierarchy).
	-->
	<bean class="org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor"/>
	 
	 
	<bean id="basicDAO" class="com.bluexml.alfresco.modules.sql.dao.BasicDAO" >
		<property name="entityManagerFactory" ref="synchroEntityManagerFactory" />
	<!-- 
	   	<property name="transactionService">
            <ref bean="transactionService"/>
        </property>
    -->    
	</bean>
	
	<bean id="basicController" class="com.bluexml.alfresco.modules.sql.service.BasicControllerImpl">
		<property name="basicDAO" ref="basicDAO" />
	</bean>
	


	<bean id="basicService" class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="proxyInterfaces">
            <value>com.bluexml.alfresco.modules.sql.service.BasicController</value>
        </property>
        <property name="target">
            <ref local="basicController"/>
        </property>
        <property name="interceptorNames">
            <list>
                <idref local="basicControllerIntegrationService_transaction"/>
                <!-- 
                <idref bean="AuditMethodInterceptor"/>
                <idref bean="exceptionTranslator"/>
                -->
            </list>
        </property>
    </bean>

    <bean id="basicControllerIntegrationService_transaction" class="org.springframework.transaction.interceptor.TransactionInterceptor">
        <property name="transactionManager">
            <ref bean="synchroTransactionManager"/>
        </property>
        <property name="transactionAttributes">
            <props>
                <prop key="*">${server.transaction.mode.default}</prop>
            </props>
        </property>
    </bean>




</beans>

<?xml version="1.0" encoding="UTF-8"?>

<project name="RWM Packager" default="build" basedir=".">

	<dirname property="RWM_PACKAGER_HOME" file="build.xml" />
	<property file="last_build.properties" />
	<property file="build.properties" />

	<tstamp>
		<format property="timestamp" pattern="yyyyMMdd_kkmmss" />
	</tstamp>

	<target name="init">
		<echo message="############## Environment variables initialization ##############" />
		<input message="Please enter deploy directory :" addproperty="DEPLOY" defaultvalue="${DEFAULT_DEPLOY}" />
		<input message="Please enter MySQL username :" addproperty="DB_USERNAME" defaultvalue="${DB_DEFAULT_USERNAME}" />
		<input message="Please enter MySQL password for user '${DB_USERNAME}' :" addproperty="DB_PASSWORD" defaultvalue="${DB_DEFAULT_PASSWORD}" />
		<input message="Please enter MySQL host :" addproperty="DB_HOST" defaultvalue="${DB_DEFAULT_HOST}" />
		<input message="Please enter MySQL port :" addproperty="DB_PORT" defaultvalue="${DB_DEFAULT_PORT}" />
		<input message="Please enter MySQL database :" addproperty="DB_DATABASE" defaultvalue="${DB_DEFAULT_DATABASE}" />

		<condition property="isMacOsX">
			<and>
				<os family="mac" />
				<os family="unix" />
			</and>
		</condition>

		<condition property="isWindows">
			<os family="Windows" />
		</condition>

		<property name="TMP" value="${BUILD}${FS}tmp" />

		<mkdir dir="${BUILD}" />
		<mkdir dir="${DEPLOY}" />
		<mkdir dir="${TMP}" />

		<propertyfile file="last_build.properties">
			<entry key="DEFAULT_BUILD" value="${BUILD}" />
			<entry key="DEFAULT_DEPLOY" value="${DEPLOY}" />
			<entry key="DB_DEFAULT_USERNAME" value="${DB_USERNAME}" />
			<entry key="DB_DEFAULT_PASSWORD" value="${DB_PASSWORD}" />
			<entry key="DB_DEFAULT_DATABASE" value="${DB_DATABASE}" />
			<entry key="DB_DEFAULT_HOST" value="${DB_HOST}" />
			<entry key="DB_DEFAULT_PORT" value="${DB_PORT}" />
		</propertyfile>

	</target>

	<target name="build" depends="init">
		<record name="${LOGS}${FS}build-${timestamp}.log" append="yes" action="start" loglevel="verbose" />
		<echo message="############## Begin RWM Installation ##############" />
		<antcall target="list-env" />
		<antcall target="install-rwm" />
		<antcall target="conf-rwm" />
		<antcall target="deploy-rwm" />
		<antcall target="clean-tmp" />
		<record name="${LOGS}${FS}build-${timestamp}.log" action="stop" />
	</target>

	<target name="list-env">
		<echo message="############## Environment variables ##############" />
		<echo>$${java.home}=${java.home}</echo>
		<echo>$${user.home}=${user.home}</echo>
		<echo>$${BUILD}=${BUILD}</echo>
		<echo>$${DEPLOY}=${DEPLOY}</echo>
		<echo>$${CATALINA_HOME}=${CATALINA_HOME}</echo>
		<echo>$${DB_USERNAME}=${DB_USERNAME}</echo>
		<echo>$${DB_PASSWORD}=${DB_PASSWORD}</echo>
		<echo>$${DB_HOST}=${DB_HOST}</echo>
		<echo>$${DB_PORT}=${DB_PORT}</echo>
		<echo>$${DB_DATABASE}=${DB_DATABASE}</echo>
		<echo>$${isMacOsX}=${isMacOsX}</echo>
		<echo>$${isWindows}=${isWindows}</echo>
	</target>

	<target name="install-rwm" depends="init">
		<echo message="############## RWM installation ##############" />
		<unzip src="${SRC}${FS}${RWM}${FS}${RWM}_${RWM_VERSION}.zip" dest="${BUILD}${FS}${RWM}_${RWM_VERSION}${FS}" />
		<echo message="####################### Unpack libraries #####" />
		<property name="LIBRARY_DIRECTORY" value="${BUILD}${FS}${RWM}_${RWM_VERSION}${FS}library" />
		<mkdir dir="${LIBRARY_DIRECTORY}" />
		<echo message="####################### Unpack DHTML TREE ####" />
		<unzip src="${SRC}${FS}${DHTML_TREE}${FS}${DHTML_TREE}.zip" dest="${LIBRARY_DIRECTORY}" />
		<echo message="####################### Unpack Draw2D ########" />
		<unzip src="${SRC}${FS}${DRAW2D}${FS}${DRAW2D}_${DRAW2D_VERSION}.zip" dest="${LIBRARY_DIRECTORY}" />
		<echo message="####################### Unpack ExtJS #########" />
		<unzip src="${SRC}${FS}${EXTJS}${FS}${EXTJS}_${EXTJS_VERSION}.zip" dest="${LIBRARY_DIRECTORY}" />
		<echo message="####################### Unpack jQuery ########" />
		<unzip src="${SRC}${FS}${JQUERY}${FS}${JQUERY}_${JQUERY_VERSION}.zip" dest="${LIBRARY_DIRECTORY}" />
		<echo message="####################### Unpack nyroModal #####" />
		<unzip src="${SRC}${FS}${NYROMODAL}${FS}${NYROMODAL}_${NYROMODAL_VERSION}.zip" dest="${LIBRARY_DIRECTORY}" />
		<echo message="####################### Unpack prototype #####" />
		<unzip src="${SRC}${FS}${PROTOTYPE}${FS}${PROTOTYPE}_${PROTOTYPE_VERSION}.zip" dest="${LIBRARY_DIRECTORY}" />
		<echo message="####################### Unpack Windows JS ####" />
		<unzip src="${SRC}${FS}${WINDOWS_JS}${FS}${WINDOWS_JS}_${WINDOWS_JS_VERSION}.zip" dest="${LIBRARY_DIRECTORY}" />
		<echo message="####################### Unpack other libraries" />
		<unzip src="${SRC}${FS}${OTHER}.zip" dest="${LIBRARY_DIRECTORY}" />
	</target>

	<target name="conf-rwm">
		<echo message="############## RWM configuration ##############" />
		<property name="ROOT_DIRECTORY" value="${BUILD}${FS}${RWM}_${RWM_VERSION}" />

		<property name="OUT_DIRECTORY" value="${ROOT_DIRECTORY}${FS}out" />
		<mkdir dir="${OUT_DIRECTORY}" />
		<chmod dir="${OUT_DIRECTORY}" perm="777" />

		<property name="COMMON_DIRECTORY" value="${ROOT_DIRECTORY}${FS}common" />
		<copy overwrite="on" file="${CONF}${FS}${RWM}${FS}${RWM_VERSION}${FS}mysql${FS}access_bdd.php" tofile="${COMMON_DIRECTORY}${FS}access_bdd.php" filtering="true">
			<filterset>
				<filter token="DbUserName" value="${DB_USERNAME}" />
				<filter token="DbPassword" value="${DB_PASSWORD}" />
				<filter token="DbHost" value="${DB_HOST}" />
				<filter token="DataBase" value="${DB_DATABASE}" />
			</filterset>
		</copy>
		<copy overwrite="on" file="${CONF}${FS}${RWM}${FS}${RWM_VERSION}${FS}mysql${FS}init.sql" tofile="${ROOT_DIRECTORY}${FS}init.sql" filtering="true">
			<filterset>
				<filter token="DataBase" value="${DB_DATABASE}" />
			</filterset>
		</copy>

		<sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://${DB_HOST}:${DB_PORT}/" userid="${DB_USERNAME}" password="${DB_PASSWORD}" src="${ROOT_DIRECTORY}/init.sql" print="yes">
			<classpath>
				<pathelement location="${TOOLS}${FS}mysql${FS}mysql-connector-java-5.1.7-bin.jar" />
			</classpath>
		</sql>

		<sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_DATABASE}" userid="${DB_USERNAME}" password="${DB_PASSWORD}" src="${ROOT_DIRECTORY}/transformation/transformations.sql" print="yes">
			<classpath>
				<pathelement location="${TOOLS}${FS}mysql${FS}mysql-connector-java-5.1.7-bin.jar" />
			</classpath>
		</sql>
	</target>

	<target name="deploy-rwm">
		<copy overwrite="on" todir="${DEPLOY}">
			<fileset dir="${BUILD}" />
		</copy>
	</target>

	<target name="clean-tmp">
		<echo message="############## Cleaning temporary files ##############" />
		<delete dir="${TMP}" />
	</target>

</project>
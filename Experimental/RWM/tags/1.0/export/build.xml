<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     10 sept. 08 11:05:17                                                        

     Transmit new version of modeler on server    
                   
     bch                                                                
     ====================================================================== -->
<project name="Transmit new version of modeler on server" default="default">
	<property name="ZIPFile.name" value="RWM_Web_modeler.zip" />
	<property name="keyFile.path" value="/Users/bch/.ssh/id_dsa" />
	<property name="mysqldump.path" value="/Applications/xampp/xamppfiles/bin/mysqldump" />
	<property name="host" value="merry.bluexml.com" />
	<property name="host_path" value="/tmp/rwm" />

	<!-- ================================= 
          target: default              
         ================================= -->
	<target name="default" depends="dumpTransformation,createZIPFile,sendZIPFile" description="--> ">
		<delete file="./${ZIPFile.name}" />
	</target>
	
	<condition property="dump_executed">
		<equals arg1="${mysqldump.returncode}" arg2="0"/>
	</condition>

	<target name="dumpTransformation">
		<exec executable="${mysqldump.path}" resultproperty="mysqldump.returncode" output="./out.sql">
			<arg line="rwm transformations metamodels generator templateModels antScript -u root"/>
		</exec>
		<antcall target="move_mysqldump"/>
		<delete file="./out.sql"/>
	</target>
	
	<target name="move_mysqldump" if="dump_executed">
		<move tofile="../source/transformation/transformations.sql">
			<fileset file="out.sql"/>
		</move>
	</target>

	<target name="createZIPFile">
		<zip destfile="./${ZIPFile.name}">
			<zipfileset dir="../source" prefix="RWM Web Modeler/source" excludes=".svn" />
		</zip>
	</target>

	<target name="sendZIPFile">
		<sshexec host="${host}" username="${username}" keyfile="${keyFile.path}" passphrase="${password}" command="if ! test -d ${host_path}; then mkdir ${host_path}; fi" />
		<scp todir="${username}@${host}:${host_path}" keyfile="${keyFile.path}" passphrase="${password}">
			<fileset file="./${ZIPFile.name}" />
			<fileset file="./target/build.xml">
			</fileset>
		</scp>
		<sshexec host="${host}" username="${username}" keyfile="${keyFile.path}" passphrase="${password}" command="ant -f ${host_path}/build.xml" />
	</target>

</project>
